{
    "componentChunkName": "component---src-components-layout-mdx-layout-tsx",
    "path": "/tutorials/misc/watchdog",
    "result": {"data":{"site":{"siteMetadata":{"title":"Toit documentation"}},"mdx":{"body":"const _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign ? Object.assign.bind() : function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nconst _frontmatter = {};\n\nconst makeShortcode = name => function MDXDefaultShortcode(props) {\n  console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n  return mdx(\"div\", props);\n};\n\nconst Note = makeShortcode(\"Note\");\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  let {\n    components\n  } = _ref,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h1\", {\n    \"id\": \"watchdogs\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h1\",\n    \"href\": \"#watchdogs\",\n    \"aria-label\": \"watchdogs permalink\",\n    \"className\": \"table-of-contents-icon before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), `Watchdogs`), mdx(\"p\", null, `This tutorial will show you how to use watchdogs to monitor the system and reset it if it hangs.`), mdx(\"p\", null, `Watchdogs are hardware timers that can be used to reset the system if it doesn't respond\nthe way it should. Users set up an interval at which the watchdog should be fed. If the\nwatchdog is not fed within that interval, the system resets. The hope is that the system\nwill be able to recover from whatever caused it to hang by doing a hard reset.`), mdx(\"h2\", {\n    \"id\": \"prerequisites\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#prerequisites\",\n    \"aria-label\": \"prerequisites permalink\",\n    \"className\": \"table-of-contents-icon before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), `Prerequisites`), mdx(\"p\", null, `We assume that you have set up your development environment as described\nin `, mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"../../setup/ide\"\n  }, `the IDE tutorial`), `.`), mdx(\"p\", null, `We also assume that you have flashed your device with Jaguar and that\nyou are familiar with running Toit programs on it.\nIf not, have a look at the `, mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"../../setup/firstprogram\"\n  }, `Hello world`), ` tutorial.`), mdx(\"p\", null, `Watchdogs use services. While not necessary, you may want to read the\n`, mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"../../containers/services\"\n  }, `services`), ` tutorial to learn more about them.`), mdx(\"h2\", {\n    \"id\": \"packages\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#packages\",\n    \"aria-label\": \"packages permalink\",\n    \"className\": \"table-of-contents-icon before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), `Packages`), mdx(\"p\", null, `While the system watchdog is part of the core libraries, the nicer\nhigh-level abstraction of watchdogs needs to be installed as a package.\nSee the `, mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"../../setup/packages\"\n  }, `packages`), ` tutorial for more information.`), mdx(\"p\", null, `To install the `, mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://pkg.toit.io/package/github.com%2Ftoitware%2Ftoit-watchdog@v1\"\n  }, `watchdog`), `\npackage run the following command:`), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-shell\"\n  }, `jag pkg install github.com/toitware/toit-watchdog@v1\n`)), mdx(\"h2\", {\n    \"id\": \"code\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#code\",\n    \"aria-label\": \"code permalink\",\n    \"className\": \"table-of-contents-icon before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), `Code`), mdx(\"p\", null, `Start a new Toit program `, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, `watchdog.toit`), ` and watch it with Jaguar.\nBe aware that the following program has some side effects, and will likely\nforce your device to reset.`), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-toit\"\n  }, `import watchdog.provider\nimport watchdog show WatchdogServiceClient\n\nmain:\n  // Start the watchdog provider.\n  provider.main\n\n  // Create a watchdog client that connects to the provider.\n  client := WatchdogServiceClient\n  // Connect to the provider that has been started earlier.\n  client.open\n\n  // Create a watchdog.\n  dog := client.create \"docs.toit.io/tutorial/my-dog\"\n\n  // Require a feeding every 60 seconds.\n  dog.start --s=60\n\n  // Feed it:\n  dog.feed\n\n  // Stop it, if not necessary:\n  dog.stop\n\n  // When stopped, close it.\n  dog.close\n\n  print \"done\"\n`)), mdx(\"p\", null, `The watchdog provider is a service that runs in the background and\nprovides watchdogs to clients. In our case the provider is started by\nthe `, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, `provider.main`), ` function.`), mdx(\"p\", null, `The client connects to the provider and creates a watchdog. The string\nthat is passed to the constructor identifies the watchdog. Even if\na program crashes, it can avoid a system reset if it restarts fast\nenough and feeds a watchdog with the same ID in time. See\nthe \"Recommendations\" section below for more information.`), mdx(\"p\", null, `We then show how to start, feed, stop and close the watchdog.`), mdx(\"p\", null, `Note that the program prints \"done\", but does not exit. This is because\nthe provider is still running in the background. For various reasons\nit is recommended to run the watchdog provider in its own container.`), mdx(Note, {\n    mdxType: \"Note\"\n  }, mdx(\"p\", null, `It is critical that the watchdog functionality isn't shut down accidentally.\nContrary to other resources, watchdogs are thus not cleaned up automatically\nwhen the program exits (cleanly or not). Instead, the underlying system\nwatchdog is kept running, thus guaranteeing that the system will reset.`), mdx(\"p\", null, `In our case a `, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, `jag run`), ` (or `, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, `jag watch`), `) might stop the program while the\nwatchdog provider is active. Despite reinstalling a new version of the\nprogram, the old watchdog provider could still be running and then\nforce a reset.`), mdx(\"p\", null, `This issue is mostly avoided if the provider\nis installed in its own container (see the next section). In that case\nreinstalling the program doesn't affect the container that contains\nthe watchdog provider.`), mdx(\"p\", null, `User programs might still be aborted by Jaguar, but by reinstalling new\nversions of them they can recover, since the names are IDs that identify\nthe watchdogs.`)), mdx(\"h2\", {\n    \"id\": \"running-the-watchdog-provider-in-a-container\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#running-the-watchdog-provider-in-a-container\",\n    \"aria-label\": \"running the watchdog provider in a container permalink\",\n    \"className\": \"table-of-contents-icon before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), `Running the watchdog provider in a container`), mdx(\"p\", null, `To run the watchdog provider in a container, we need to create a\nsimple entrypoint script that starts the provider. Create a new file\n`, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, `watchdog-provider.toit`), ` with the following content:`), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-toit\"\n  }, `import watchdog.provider\n\nmain:\n  provider.main\n`)), mdx(\"p\", null, `Install it on your device with the following command:`), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-shell\"\n  }, `jag container install watchdog watchdog-provider.toit\n`)), mdx(\"p\", null, `This installs and starts the watchdog provider in a container named\n`, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, `watchdog`), `. See the `, mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"../../containers\"\n  }, `container`), ` tutorial for more\ninformation about containers.`), mdx(\"p\", null, `Once installed, other containers can connect to the watchdog provider\nwithout having to start it themselves.`), mdx(\"h2\", {\n    \"id\": \"using-the-shared-watchdog-provider\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#using-the-shared-watchdog-provider\",\n    \"aria-label\": \"using the shared watchdog provider permalink\",\n    \"className\": \"table-of-contents-icon before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), `Using the shared watchdog provider`), mdx(\"p\", null, `We can now modify our watchdog program to use the shared watchdog`), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-toit\"\n  }, `import watchdog show WatchdogServiceClient\n\nmain:\n  client := WatchdogServiceClient\n  client.open  // Now connects to the shared watchdog provider.\n\n  dog := client.create \"docs.toit.io/tutorial/my-dog\"\n  ...\n`)), mdx(\"p\", null, `Note that multiple containers can connect to the same watchdog provider.`), mdx(\"p\", null, `Try to reduce the feeding interval and remove the `, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, `stop`), `/`, mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, `close`), ` to see how\nthe system reboots.`), mdx(\"h2\", {\n    \"id\": \"recommendations\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h2\",\n    \"href\": \"#recommendations\",\n    \"aria-label\": \"recommendations permalink\",\n    \"className\": \"table-of-contents-icon before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), `Recommendations`), mdx(\"p\", null, `Watchdogs are a powerful tool to make sure that the system doesn't hang. In\nthis section we give some recommendations on how best to use them in Toit.`), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, `Give watchdogs enough time, or disable them when appropriate. For example,\na system update might disable other programs. If these other programs had\na watchdog timer, then the update process could be interrupted by the\nstale watchdog of the stopped program.`), mdx(\"li\", {\n    parentName: \"ol\"\n  }, `Feed when important actions happen. For example, feed the dog, when data\nhas been uploaded, or when a sensor has been read and processed.\nContrary to the examples do `, mdx(\"em\", {\n    parentName: \"li\"\n  }, `not`), `\nfeed a watchdog after it has been created. If your application has a\ncrash loop it could start up, create the watchdog, feed it, and then die\nimmediately afterwards.`), mdx(\"li\", {\n    parentName: \"ol\"\n  }, `Use different watchdogs. Feel free to have a watchdog for uploading (for\nexample every 30 minutes), and another that is fed every 3 minutes, when\nthe device expects a ping from a server.`), mdx(\"li\", {\n    parentName: \"ol\"\n  }, `Make sure to clean up `, mdx(\"em\", {\n    parentName: \"li\"\n  }, `after`), ` the watchdog has reset your system. If\nyour board has external sensors/peripherals, they might not be in a clean\nstate. You can use the\n`, mdx(\"a\", {\n    parentName: \"li\",\n    \"href\": \"https://libs.toit.io/esp32/library-summary#reset-reason(0%2C0%2C0%2C)\"\n  }, `reset-reason`), `\nfunction to determine why a system has booted. If the reason wasn't a\ndeepsleep, then you have to assume that the external peripherals are in an unknown\nstate.`)));\n}\n;\nMDXContent.isMDXComponent = true;","tableOfContents":{"items":[{"url":"#watchdogs","title":"Watchdogs","items":[{"url":"#prerequisites","title":"Prerequisites"},{"url":"#packages","title":"Packages"},{"url":"#code","title":"Code"},{"url":"#running-the-watchdog-provider-in-a-container","title":"Running the watchdog provider in a container"},{"url":"#using-the-shared-watchdog-provider","title":"Using the shared watchdog provider"},{"url":"#recommendations","title":"Recommendations"}]}]}}},"pageContext":{"title":"Watchdogs","id":"96f22bd7-5337-5900-b1e1-f53d9d73749c"}},
    "staticQueryHashes": ["2197327828"]}