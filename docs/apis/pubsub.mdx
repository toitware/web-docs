
# PubSub

Applications communicate with each other through publish/subscribe (PubSub), an asynchronous messaging service that decouples services that produces messages from the services processing them.

An application can publish serializable data on a topic which is then sent to all subscribers. Applications can also subscribe to a topic to receive all the publications on this topic.

PubSub can be used internally on devices through the [PubSub library](https://libs.toit.io/pubsub/library-summary) and externally using the [PubSub GRPC API](https://github.com/toitware/api/tree/master/proto/toit/api/pubsub).

## Concepts

- topic: A named resource which is used when messages are published.

  - Device topic: A topic that enables intra-communication on the device. These topics will be prefixed with: `device:`

  - Cloud topic: A topic that enables inter-communication between devices and external systems. These topics will be prefixed with: `cloud:`

- subscription: an identifier of a stream of messages from a specific topic. Note that it is possible to do concurrent reads on one subscription. When doing so, the concurrent reads will receive different batches of the same data set, making it easier to make ingestion concurrent.

- message: the combination of the data from the publisher and an identification of the sender.

See some examples of PubSub communication between apps in the [Tutorials](../../tutorials/pubsub) section.

## Cloud based PubSub subscriptions

<Tabs>
<Tab label="Console">

Go to the [Data](https://console.toit.io/data) section in the Toit console, choose the PubSub tab, and click the **Create Subscription** button.
Provide a name to the topic, which is prefixed with `cloud:` as in `cloud:topic-name`.
You can provide a name to the subscription, in order to give a description of the topic or in which scenario it is used.

Once you have created a PubSub subscription, you can view the number of unacknowledged messages for that subscription, as well as the age of the oldest unacknowledged message for a specific time interval
in two graphs, by clicking the subscription.

Delete a subscription with the bin icon.

Use the CLI commands to acknowledge messages for a subscription.

</Tab>
<Tab label="CLI">

Create an external pubsub subscription with

```shell
toit pubsub subscription create topic-filter subscription-name
```

where `topic-filter` can be replaced with `cloud:<topic-name>` and `subscription-name` is replaced with the name of the subscription to be created.

To list existing subscriptions,

```shell
toit pubsub subscription list cloud:
```

To read a subscription and acknowledge messages as they are read, use

```shell
toit pubsub read cloud:topic-name subscription-name
```

To automatically acknowledge messages, add the `--auto-ack` flag.

For example, to read data from a subscription named `temperature`, on a topic named `cloud:my-topic` which automatically acknowledges messages and starts making progress on the subscription, use

```shell
toit pubsub read cloud:my-topic temperature --auto-ack
```

</Tab>
</Tabs>

## Additional PubSub features

PubSub messages can be sent from the cloud to one specific device only by providing the `device-id` in the command:

```shell
toit pubsub write cloud:<topic-name>?device-id=<id> <name> -- <write a message>
```

It is also possible to create server-side PubSub subscriptions across multiple topics as long as they share a common prefix.

For example, create a subscription for the topics `cloud:foo/bar` and `cloud:foo/baz` with

```shell
toit pubsub subscription create "cloud:foo/**" subscription-name
```
